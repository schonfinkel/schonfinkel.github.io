<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-04-07 Mon 20:42 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Concurrent Erlang</title>
<meta name="author" content="Marcos Benevides" />
<meta name="generator" content="Org Mode" />
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<!-- syntax highlighting -->
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/default.min.css">
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/erlang.min.js"></script>
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/fsharp.min.js"></script>
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/nix.min.js"></script>
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/yaml.min.js"></script>
<!-- D3.js for the Org-roam graph -->
<script type="text/javascript" src ="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
<!-- For LaTeX -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="https://schonfinkel.github.io/static/css/main.css" rel="stylesheet">
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  // block
      inlineMath: [['\\(', '\\)']]                  // inline
    }
  };
</script>
</head>
<body>
<header id="preamble" class="status">
<nav>
  <img
    src="https://schonfinkel.github.io/static/img/logo.png"
    alt="logo"
    width="128"
    height="128"
  />
  <div>
    <h3>"Writing is nothing more than a guided dream."</h3>
  </div>
  <ul>
    <li><a href="https://schonfinkel.github.io/index.html">Home</a></li>
    <li><a href="https://schonfinkel.github.io/blog.html">Blog</a></li>
    <li><a href="https://schonfinkel.github.io/notes.html">Notes</a></li>
    <li><a href="https://schonfinkel.github.io/static/cv.pdf">CV</a></li>
    <li><a href="https://schonfinkel.github.io/static/blogroll.xml">BlogRoll</a></li>
    <li><a href="https://schonfinkel.github.io/rss.xml"><i class='bx bx-rss'></i></a></li>
  </ul>
</nav>
</header>
<main id="content" class="content">
<header>
<h1 class="title">Concurrent Erlang</h1>
</header><blockquote>
<p>
I’m sure you’ve met processes before, but only in the context of operating
systems. In Erlang, processes belong to the programming language and not the
operating system. This means that Erlang processes will have the same logical
behavior on any operating system, so we can write portable concurrent code that
can run on any operating system that supports Erlang.
</p>

<p>
In Erlang:
</p>
<ul class="org-ul">
<li>Creating and destroying processes is very fast.</li>
<li>Sending messages between processes is very fast.</li>
<li>Processes behave the same way on all operating systems.</li>
<li>We can have very large numbers of processes.</li>
<li>Processes share no memory and are completely independent.</li>
<li>The only way for processes to interact is through message passing.</li>
</ul>
<p>
(<a href="#citeproc_bib_item_1">Armstrong 2013, 181</a>)
</p>
</blockquote>
<div id="outline-container-org27bf3d2" class="outline-2">
<h2 id="org27bf3d2">Processes</h2>
<div class="outline-text-2" id="text-org27bf3d2">
<p>
In <a href="20240619114451-erlang.html#ID-de7d0e94-618f-4982-b3e5-8806d88cad5d">Erlang</a>, creation of a parallel process is achieved by evaluating the <code>spawn</code>
primitive. This primitive creates a concurrent process and returns a process
identifier (PID) that can used to interact with the newly created process:
</p>

<div class="org-src-container">
<pre class="src src-erlang">Pid = spawn(ModName, FuncName, [Arg1, Arg2, ..., ArgN]).
</pre>
</div>


<figure id="orga1b9da8">
<img src="../static/img/notes/erlang_spawn.png" alt="erlang_spawn.png">

</figure>

<ul class="org-ul">
<li>This BIF never fails</li>
<li>A process can either terminate:
<ul class="org-ul">
<li>Abormally when run-time errors occur</li>
<li>Normally when there is no more code to execute</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org1c9280c" class="outline-3">
<h3 id="org1c9280c">Modeling Concurrency</h3>
<div class="outline-text-3" id="text-org1c9280c">

<figure id="orgd6acf08">
<img src="../static/img/notes/erlang_send.png" alt="erlang_send.png">

</figure>

<p>
The syntax <code>Pid ! Msg</code> means "send the message <code>Msg</code> to the process <code>Pid</code>", where <code>Msg</code>
is from any valid <a href="20240619114451-erlang.html#ID-de7d0e94-618f-4982-b3e5-8806d88cad5d">Erlang</a> data type. Also, <code>Pid1 ! Pid2 ! ... ! Msg</code> means send the
message Msg to all the processes <code>Pid1</code>, <code>Pid2</code>, and so on. The <code>receive ... end</code>
construct is used for a process to read a message that has been sent:
</p>

<div class="org-src-container">
<pre class="src src-erlang">receive
   Pattern1 [when Guard1] -&gt; Expression1;
   Pattern2 [when Guard2] -&gt; Expression2;
   ...
end
</pre>
</div>

<ul class="org-ul">
<li>Sending a message will never fail.</li>
<li>A message sent to non-existing processes are throw away.</li>
<li>Received messages are stored in the process' mailbox.</li>
<li>Mailboxes are scanned sequentially.</li>
<li><p>
If a message fails to be pattern matched, it's saved in a queue for later
processing and the process waits for the next message. It is possible to
update a process with a new version of the code that retrieves those messages.
</p>

<blockquote>
<p>
What happens when a message doesn’t match any of the clauses in a receive
statement? It remains in the process mailbox indefinitely, causing a memory
leakage that over time could also cause the runtime system to run out of
memory and crash. Not handling unknown messages should therefore be treated as
a bug. Either these messages should not have been sent to this process in the
first place, or they should be handled, possibly just by being retrieved from
the mailbox and ignored. (<a href="#citeproc_bib_item_2">Cesarini and Thompson 2009, 109</a>)
</p>
</blockquote>

<p>
The erlang shell (<code>erl</code>) is itself a process, you can test its message-passing
functionalities by using the <code>self</code> function:
</p>

<div class="org-src-container">
<pre class="src src-shell">    1&gt; self() ! hello.
    hello
    2&gt; receive X -&gt; X end.
    hello
</pre>
</div>

<ul class="org-ul">
<li>Messages can be matched and selectivelly retrieved.</li>
<li><p>
We can force an order (emulating a priority queue) by using multiple receives:
</p>


<figure id="orgd4c3888">
<img src="../static/img/notes/erlang_selective.png" alt="erlang_selective.png">

</figure>

<div class="org-src-container">
<pre class="src src-erlang">      receive
        {foo, _} -&gt;
        (...)
      end,
      (...)
      receive
        {bar, _} -&gt;
        (...)
      end,
</pre>
</div>

<p>
this way the message <code>{foo, ...}</code> is received before the message <code>{bar, ...}</code>.
</p></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org75f9362" class="outline-3">
<h3 id="org75f9362">Registered Processes</h3>
<div class="outline-text-3" id="text-org75f9362">
<table>


<colgroup>
<col  class="org-left">

<col  class="org-left">
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">BIF</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>register(Name, Pid)</code></td>
<td class="org-left">Associates the name <code>Name</code>, an atom, with the process <code>Pid</code>.</td>
</tr>

<tr>
<td class="org-left"><code>registered/0</code></td>
<td class="org-left">Returns a list of names that have been registered using <code>register/2</code>.</td>
</tr>

<tr>
<td class="org-left"><code>whereis(Name)</code></td>
<td class="org-left">Returns the pid registered under <code>Name</code>, or <code>undefined</code> if the name is not registered.</td>
</tr>

<tr>
<td class="org-left"><code>registered()</code></td>
<td class="org-left">Return a list of all registered processes in the system.</td>
</tr>
</tbody>
</table>

<ul class="org-ul">
<li><p>
Sending messages to a non-existing registered process causes the calling
process to terminate with a <code>badarg</code> error.
</p>

<blockquote>
<p>
It is a feature of Erlang memory management that atoms are not garbage
collected. Once you’ve created an atom, it remains in the atom table regardless
of whether it is referenced in the code. This can be a potential problem if you
decide to register transient processes with an alias derived from converting a
string to an atom with the <code>list_to_atom/1</code> BIF. If you have millions of users
logging on to your system every day and you create a registered process for the
duration of their sessions, don’t be surprised if you end up running out of
memory.
</p>

<p>
You would be much better off storing the mapping of users to pids in a session
table. It is best to register only processes with a long life span, and if you
really must convert a string to use as an alias, use <code>list_to_existing_atom/1</code> to
ensure that your system does not suffer memory leakages.
</p>

<p>
(<a href="#citeproc_bib_item_2">Cesarini and Thompson 2009, 104</a>)
</p>
</blockquote></li>
</ul>
</div>
</div>
<div id="outline-container-orgaf818bd" class="outline-3">
<h3 id="orgaf818bd">Timeouts</h3>
<div class="outline-text-3" id="text-orgaf818bd">
<ul class="org-ul">
<li>If the message <code>Msg</code> is received within the <code>TimeOut</code>, <code>expr01</code> will be
executed. Otherwise, <code>expr02</code> will be executed.</li>
<li><code>TimeOut</code> is an integer denoting the time in miliseconds or the Atom <code>infinity</code>.</li>
</ul>


<figure id="orgd20dfa5">
<img src="../static/img/notes/erlang_timeout.png" alt="erlang_timeout.png">

</figure>

<div class="org-src-container">
<pre class="src src-erlang">  receive 
    Msg -&gt;
      &lt;expr01&gt;
    after TimeOut -&gt;
      &lt;expr02&gt;
  end
</pre>
</div>
</div>
</div>
<div id="outline-container-orge18b599" class="outline-3">
<h3 id="orge18b599">Skeleton of an Erlang Process</h3>
<div class="outline-text-3" id="text-orge18b599">
<p>
Most processes in Erlang share a common lifecycle:
</p>

<ul class="org-ul">
<li>Be spawned and initialized</li>
<li>Repeatedly receive messages, handle them, and send replies</li>
<li>Be terminated (normally or abnormally)</li>
</ul>


<figure id="org803851e">
<img src="../static/img/notes/erlang_process_skeleton.png" alt="erlang_process_skeleton.png">

</figure>
</div>
</div>
</div>
<div id="outline-container-org16dae41" class="outline-2">
<h2 id="org16dae41">Concurrency-Related Bottlenecks</h2>
<div class="outline-text-2" id="text-org16dae41">
<blockquote>
<p>
Processes are said to act as <i>bottlenecks</i> when, over time, they are sent messages at a
faster rate than they can handle them, resulting in large mailbox queues.
</p>

<p>
(&#x2026;)
</p>

<p>
The only way to discover whether there are any bottlenecks is to observe the throughput
and message queue buildup when stress-testing the system. Simple remedies to message
queue problems can be achieved by optimizing the code and fine-tuning the operating
system and VM settings. (<a href="#citeproc_bib_item_2">Cesarini and Thompson 2009, 109</a>)
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgae9e116" class="outline-2">
<h2 id="orgae9e116">References:</h2>
<div class="outline-text-2" id="text-orgae9e116">
<style>.csl-entry{text-indent: -1.5em; margin-left: 1.5em;}</style><div class="csl-bib-body">
  <div class="csl-entry"><a id="citeproc_bib_item_1"></a>Armstrong, Joe. 2013. “Programming Erlang: Software for a Concurrent World.”</div>
  <div class="csl-entry"><a id="citeproc_bib_item_2"></a>Cesarini, Francesco, and Simon Thompson. 2009. <i>Erlang Programming: A Concurrent Approach to Software Development</i>. O’Reilly Media, Inc.</div>
</div>
</div>
</div>
<div id="outline-container-orga4a48af" class="outline-2">
<h2 id="orga4a48af">Backlinks:</h2>
<div class="outline-text-2" id="text-orga4a48af">
<ul class="org-ul">
<li><a href="./20241001192402-error_handling_in_erlang.html">Error Handling in Erlang</a></li>
</ul>
</div>
</div>
</main>
<footer id="postamble" class="status">
<footer>
  </br>
  <p>
  Built with <a href="https://orgmode.org/">Orgmode</a>, <a href="https://www.gnu.org/software/emacs/">Emacs</a> and <a href="https://nixos.org/">Nix</a>, source code availiable <a href="https://github.com/schonfinkel/schonfinkel.github.io">here</a>.
  </p>
</footer>
</footer>
</body>
</html>

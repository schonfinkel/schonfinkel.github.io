<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2025-07-01 Tue 10:31 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gen Server</title>
<meta name="author" content="Marcos Benevides" />
<meta name="generator" content="Org Mode" />
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<!-- syntax highlighting -->
<link rel="stylesheet" href="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/styles/default.min.css">
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/highlight.min.js"></script>
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/erlang.min.js"></script>
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/fsharp.min.js"></script>
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/nix.min.js"></script>
<script src="https://unpkg.com/@highlightjs/cdn-assets@11.9.0/languages/yaml.min.js"></script>
<!-- D3.js for the Org-roam graph -->
<script type="text/javascript" src ="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
<!-- For LaTeX -->
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="https://schonfinkel.github.io/static/css/main.css" rel="stylesheet">
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  // block
      inlineMath: [['\\(', '\\)']]                  // inline
    }
  };
</script>
</head>
<body>
<header id="preamble" class="status">
<nav>
  <img
    src="https://schonfinkel.github.io/static/img/logo.png"
    alt="logo"
    width="128"
    height="128"
  />
  <div>
    <h3>"Writing is nothing more than a guided dream."</h3>
  </div>
  <ul>
    <li><a href="https://schonfinkel.github.io/index.html">Home</a></li>
    <li><a href="https://schonfinkel.github.io/blog.html">Blog</a></li>
    <li><a href="https://schonfinkel.github.io/notes.html">Notes</a></li>
    <li><a href="https://schonfinkel.github.io/static/cv.pdf">CV</a></li>
    <li><a href="https://schonfinkel.github.io/static/blogroll.xml">BlogRoll</a></li>
    <li><a href="https://schonfinkel.github.io/rss.xml"><i class='bx bx-rss'></i></a></li>
  </ul>
</nav>
</header>
<main id="content" class="content">
<header>
<h1 class="title">Gen Server</h1>
</header><blockquote>
<p>
Much of the work you think of as the core of a program - calculating results,
storing information, and preparing replies - will fit neatly into the <code>gen_server</code>
behavior. It provides a core set of methods that let you set up a process,
respond to requests, end the process gracefully, and even pass state to a new
process if this one needs to be upgraded in place. (<a href="#citeproc_bib_item_3">Laurent 2017, 148</a>)
</p>
</blockquote>

<p>
<code>gen_server</code> is a generic server process that implements a standard set of
interface functions and functionality for tracing and error reporting, it also
fits an <a href="20240928181517-otp.html#ID-6ed3a191-0128-453e-b0b6-37c48593a6f0">OTP</a> supervision tree.
</p>

<blockquote>
<p>
Here’s the simple three-point plan for writing a <code>gen_server</code> callback module:
</p>
<ol class="org-ol">
<li>Decide on a callback module name.</li>
<li>Write the interface functions.</li>
<li>Write the six required callback functions in the callback module.</li>
</ol>

<p>
(<a href="#citeproc_bib_item_1">Armstrong 2013, 366</a>)
</p>
</blockquote>
<div id="outline-container-org4938c79" class="outline-2">
<h2 id="org4938c79">Callback Structure</h2>
<div class="outline-text-2" id="text-org4938c79">
<p>
The <code>gen_server</code> behaviour interface contains six callback functions:
</p>

<ul class="org-ul">
<li><code>init/1</code></li>
<li><code>handle_call/3</code></li>
<li><code>handle_cast/2</code></li>
<li><code>handle_info/2</code></li>
<li><code>terminate/2</code></li>
<li><code>code_change/3</code></li>
</ul>
</div>
<div id="outline-container-org2db8c4f" class="outline-3">
<h3 id="org2db8c4f">Starting the Server (<code>init/1</code>)</h3>
<div class="outline-text-3" id="text-org2db8c4f">
<p>
<code>gen_server:start_link(Name, Mod, InitArgs, Opts)</code> starts the server created by the <code>gen_server:start_link/4</code> call:
</p>

<ul class="org-ul">
<li>The generic server starts by calling <code>Mod:init(InitArgs)</code> (where <code>Mod</code> is the name
of the callback module). If <code>{ok, State}</code> is returned, then the server is
successfully started the server with an initial state.</li>
<li>If the first argument was atom <code>{global, Name}</code>, it would start a global server
that could be accessed on a cluster of Erlang nodes.</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 1: </span>A template with an example <code>init</code> callback function</label><pre class="src src-erlang">  init([]) -&gt;
    {ok, #state{}}.
</pre>
</div>
</div>
</div>
<div id="outline-container-orgff5fcdb" class="outline-3">
<h3 id="orgff5fcdb">Calling the Server</h3>
<div class="outline-text-3" id="text-orgff5fcdb">
</div>
<div id="outline-container-orgb7e5f2b" class="outline-4">
<h4 id="orgb7e5f2b"><code>handle_call/3</code></h4>
<div class="outline-text-4" id="text-orgb7e5f2b">
<p>
Handles synchronous requests sent to the server by <code>gen_server:call/2</code>.
</p>

<ul class="org-ul">
<li><code>gen_server:call(?MODULE, Term)</code> is used for a remote procedure call to the server.</li>
</ul>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 2: </span><code>handle_call/3</code> sends a synchronous message to a <code>gen_server</code> process and waits for a reply.</label><pre class="src src-erlang">  handle_call(_Request, _From, State) -&gt;
    Reply = ok,
    {reply, Reply, State}.
</pre>
</div>

<blockquote>
<p>
Normally we return <code>{reply, Reply, NewState}</code>. When this happens, <code>Reply</code> goes back
to the client, where it becomes the return value of <code>gen_server:call</code>. <code>NewState</code> is
the next state of the server.
</p>

<p>
The other return values, <code>{noreply, ...}</code> and <code>{stop, ...}</code> are used relatively
infrequently. <code>noreply</code> causes the server to continue, but the client will wait
for a reply so the server will have to delegate the task of replying to some
other process. Calling <code>stop</code> with the appropriate arguments will stop the
server. (<a href="#citeproc_bib_item_1">Armstrong 2013, 372</a>)
</p>
</blockquote>
</div>
<div id="outline-container-orgd9dcd98" class="outline-5">
<h5 id="orgd9dcd98">Call Timeouts</h5>
<div class="outline-text-5" id="text-orgd9dcd98">
<div class="org-src-container">
<pre class="src src-erlang">  gen_server:call(Server, Message, TimeOut) -&gt; Reply
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgcc52334" class="outline-4">
<h4 id="orgcc52334"><code>handle_cast/2</code></h4>
<div class="outline-text-4" id="text-orgcc52334">
<p>
To send an asynchronous message to a <code>gen_server</code> process, the requests originate
in the <code>gen_server:cast/2</code> call, which sends a message to a server process and
immediately returns.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 3: </span>Example of a <code>handle_call/2</code> template.</label><pre class="src src-erlang">  handle_cast(_Msg, State) -&gt;
    {noreply, State}.
</pre>
</div>

<p>
The handler usually just returns <code>{noreply, NewState}</code>, which changes the state of
the server, or <code>{stop, ...}</code>, which stops the server.
</p>
</div>
</div>
</div>
<div id="outline-container-orgdbe6dfe" class="outline-3">
<h3 id="orgdbe6dfe">Spontaneous Messages to the Server</h3>
<div class="outline-text-3" id="text-orgdbe6dfe">
<blockquote>
<p>
The callback function <code>handle_info(Info, State)</code> is used for handling spontaneous
messages to the server. Spontaneous messages are any messages that arrive at the
server that were not sent by explicitly calling <code>gen_server:call</code> or
<code>gen_server:cast</code>. (<a href="#citeproc_bib_item_1">Armstrong 2013, 372</a>)
</p>
</blockquote>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 4: </span>Example implementation of a <code>handle_info/2</code> callback. The return values are the same as for <code>handle_cast/2</code>.</label><pre class="src src-erlang">  handle_info(_Info, State) -&gt;
    {noreply, State}.
</pre>
</div>
</div>
</div>
<div id="outline-container-org73b8498" class="outline-3">
<h3 id="org73b8498">Termination</h3>
<div class="outline-text-3" id="text-org73b8498">
<blockquote>
<p>
Stopping the server requires the callbacks to return different tuples:
</p>

<ul class="org-ul">
<li><code>init/1</code> can return <code>{stop, Reason}</code></li>
<li><code>handle_call/3</code> can return <code>{stop, Reason, Reply, LoopData}</code></li>
<li><code>handle_cast/2</code> can return <code>{stop, Reason, LoopData}</code></li>
<li><code>handle_info/2</code> can return <code>{stop, Reason, LoopData}</code></li>
</ul>

<p>
These return values terminate with the same behavior as if <code>exit(Reason)</code> were
called. In the case of calls and casts, before exiting, the callback function
<code>terminate(Reason, LoopData)</code> is called. It allows the server to clean up after
itself before being shut down. Any value returned by <code>terminate/2</code> is ignored.
</p>

<p>
(<a href="#citeproc_bib_item_2">Cesarini and Vinoski 2016, 89</a>)
</p>
</blockquote>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 5: </span>Example of a <code>terminate/2</code> implementation, this callback is raised so you have a chance to clean things up, notice that no <code>State</code> is returned.</label><pre class="src src-erlang">  terminate(_Reason, _State) -&gt;
    ok.
</pre>
</div>
</div>
</div>
<div id="outline-container-org3c8cc8b" class="outline-3">
<h3 id="org3c8cc8b">Code Change</h3>
<div class="outline-text-3" id="text-org3c8cc8b">
<p>
The callback <code>code_change/3</code> function is called by the release handling subsystem
when the system performs a software upgrade.
</p>

<div class="org-src-container">
<label class="org-src-name"><span class="listing-number">Listing 6: </span>Converts process state when code is changed.</label><pre class="src src-erlang">  code_change(_OldVsn, State, _Extra) -&gt;
    {ok, State}.
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orga89dbd1" class="outline-2">
<h2 id="orga89dbd1">Patterns</h2>
<div class="outline-text-2" id="text-orga89dbd1">
</div>
<div id="outline-container-org3a74c5f" class="outline-3">
<h3 id="org3a74c5f">Efficient TCP Server</h3>
<div class="outline-text-3" id="text-org3a74c5f">
<blockquote>
<p>
A useful pattern for implementing a server that should handle multiple
concurrent requests is to have a <code>gen_server</code> managed by a simple one-for-one
<a href="20241013103835-supervisor.html#ID-2daf1307-afb4-49e4-98cb-66ac7eb27cf0">Supervisor</a>. (&#x2026;) . In this case, a single <code>gen_server</code> child process — a handler —is
initially spawned to wait on accept, listening for new connections. When a
connection is established, this <code>gen_server</code> tells the <code>supervisor</code> to spawn a new
handler process — a clone of the <code>gen_server</code> — and immediately proceeds with servicing
the current connection while the clone takes over the job of waiting for the
next connection. (<a href="#citeproc_bib_item_4">Logan, Merritt, and Carlsson 2010, 262</a>)
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org17784fd" class="outline-3">
<h3 id="org17784fd">Generic Server Timeouts</h3>
</div>


<div id="outline-container-org46e69bc" class="outline-3">
<h3 id="org46e69bc">Hibernate Behaviour</h3>
<div class="outline-text-3" id="text-org46e69bc">
<blockquote>
<p>
If instead of a timeout value or the atom infinity we return the atom hibernate,
the server will reduce its memory footprint and enter a wait state. You will
want to use hibernate when servers that receive intermittent, memory-intensive
requests are causing the system to run low on memory.
</p>

<p>
(<a href="#citeproc_bib_item_2">Cesarini and Vinoski 2016, 97</a>)
</p>
</blockquote>
</div>
</div>
</div>
<div id="outline-container-org7e7d9c0" class="outline-2">
<h2 id="org7e7d9c0">References:</h2>
<div class="outline-text-2" id="text-org7e7d9c0">
<style>.csl-entry{text-indent: -1.5em; margin-left: 1.5em;}</style><div class="csl-bib-body">
  <div class="csl-entry"><a id="citeproc_bib_item_1"></a>Armstrong, Joe. 2013. “Programming Erlang: Software for a Concurrent World.”</div>
  <div class="csl-entry"><a id="citeproc_bib_item_2"></a>Cesarini, Francesco, and Steve Vinoski. 2016. <i>Designing for Scalability with Erlang/Otp: Implement Robust, Fault-Tolerant Systems</i>. O’Reilly Media, Inc.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_3"></a>Laurent, Simon St. 2017. <i>Introducing Erlang: Getting Started in Functional Programming</i>. O’Reilly Media, Inc.</div>
  <div class="csl-entry"><a id="citeproc_bib_item_4"></a>Logan, Martin, Eric Merritt, and Richard Carlsson. 2010. <i>Erlang and Otp in Action</i>. Manning Publications Co.</div>
</div>
</div>
</div>
<div id="outline-container-org9b4d3ae" class="outline-2">
<h2 id="org9b4d3ae">Backlinks:</h2>
<div class="outline-text-2" id="text-org9b4d3ae">
<ul class="org-ul">
<li><a href="./20250407171238-gen_fsm.html">Gen FSM</a></li>
<li><a href="./20240928181517-otp.html">OTP</a></li>
</ul>
</div>
</div>
</main>
<footer id="postamble" class="status">
<footer>
  </br>
  <p>
  Built with <a href="https://orgmode.org/">Orgmode</a>, <a href="https://www.gnu.org/software/emacs/">Emacs</a> and <a href="https://nixos.org/">Nix</a>, source code availiable <a href="https://github.com/schonfinkel/schonfinkel.github.io">here</a>.
  </p>
</footer>
</footer>
</body>
</html>

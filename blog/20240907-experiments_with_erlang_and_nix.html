<!DOCTYPE html>
<html lang="en">
<head>
<!-- 2024-12-26 Thu 13:34 -->
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Some experiments with Erlang and NixOS</title>
<meta name="author" content="Marcos Benevides" />
<meta name="generator" content="Org Mode" />
<style type="text/css">
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link href="https://unpkg.com/boxicons@2.1.4/css/boxicons.min.css" rel="stylesheet">
<script type="text/javascript" src ="https://d3js.org/d3.v7.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/d3/7.9.0/d3.min.js"></script>
<script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-chtml.js"></script>
<link href="/home/runner/work/schonfinkel.github.io/schonfinkel.github.io/public/static/css/main.css" rel="stylesheet">
<script>
  MathJax = {
    tex: {
      displayMath: [['\\[', '\\]'], ['$$', '$$']],  // block
      inlineMath: [['\\(', '\\)']]                  // inline
    }
  };
</script>
</head>
<body>
<header id="preamble" class="status">
<nav>
  <img
    src="/home/runner/work/schonfinkel.github.io/schonfinkel.github.io/public/static/img/logo.png"
    alt="logo"
    width="128"
    height="128"
  />
  <div>
    <h3>"Writing is nothing more than a guided dream."</h3>
  </div>
  <ul>
    <li><a href="/home/runner/work/schonfinkel.github.io/schonfinkel.github.io/public/index.html">Home</a></li>
    <li><a href="/home/runner/work/schonfinkel.github.io/schonfinkel.github.io/public/blog.html">Blog</a></li>
    <li><a href="/home/runner/work/schonfinkel.github.io/schonfinkel.github.io/public/notes.html">Notes</a></li>
    <li><a href="/home/runner/work/schonfinkel.github.io/schonfinkel.github.io/public/blogroll.html">BlogRoll</a></li>
  </ul>
</nav>
</header>
<main id="content" class="content">
<header>
<h1 class="title">Some experiments with Erlang and NixOS</h1>
<p class="subtitle" role="doc-subtitle">Crafing a development environment for a monorepo with Zig, Erlang, Nix and Postgres</p>
</header><p>
<b>Updated at <span class="timestamp-wrapper"><span class="timestamp">&lt;2024-11-02 Sat&gt;</span></span>: I've changed the way we package our erlang
project with Nix, mostly for the better</b>.
</p>

<p>
Recently I've been collaborating with friends on <a href="https://github.com/Dr-Nekoma/lyceum">Lyceum</a>, an MMO game with an
<a href="https://www.erlang.org/">Erlang</a> backend and a <a href="https://ziglang.org/">Zig</a> + <a href="https://www.raylib.com/">Raylib</a> client (as if erlang wasn't a weird enough of
a choice). Now, this is an unusual combination, but that's the whole reason <a href="https://github.com/Dr-Nekoma">our
pesky group</a> exists in the first place (if you want to know more check <a href="https://duing.dev/posts/beyondhackers/">my
friend's Lemos post</a>).
</p>

<p>
There is also a couple of standards we try to follow when doing this project, all
of the team works with microservices all day in their normal jobs, so whenever
we want to do something we try follow some simple rules:
</p>

<ol class="org-ol">
<li>Can we develop all of the project parts locally? Preferably with no
networking as well (besides pulling dependencies).</li>
<li>Can we do so by leveraging a couple handy tools to their limit?</li>
</ol>

<p>
One can imagine that setting up such a development environment might be
nightmarish, but thankfully the 21st century brought us some interesting tools
that make Unix less of a mess to deal with, and yes, I'm talking about <a href="https://nixos.org/">Nix</a>. My
goal here is to show people what our development experience looks like and maybe
convince a few souls dealing with more normal tools (<code>brew</code>, <code>asdf</code>, <code>&lt;insert random
linux package manager&gt;</code>, &#x2026;) to at least give Nix a try.
</p>
<div id="outline-container-org64fc90f" class="outline-2">
<h2 id="org64fc90f">Devenv</h2>
<div class="outline-text-2" id="text-org64fc90f">
<p>
We use <a href="https://devenv.sh/">devenv</a> to setup our development shell, think of it as your favorite
programming language's envinroment and dependency manager (<code>pip</code>, <code>poetry</code>, <code>nvm</code>,
<code>rvm</code>, &#x2026;) but capable of installing anything availiable on <a href="https://search.nixos.org/packages">nixpkgs</a> and
much more.
</p>
</div>
<div id="outline-container-org31c96c6" class="outline-3">
<h3 id="org31c96c6">A unified development shell for Erlang and Zig</h3>
<div class="outline-text-3" id="text-org31c96c6">
<p>
No one is expected to have <code>Erlang</code>, <code>Zig</code> and <code>Postgres</code> installed, nor are they
expected to have any of the environment variables needed for this project to
work, the development shell already does all of that boring stuff for
you. Here's a snippet of what it looks like:
</p>

<div class="org-src-container">
<pre class="src src-nix">  # (...)
  devShells =
    let
      linuxPkgs = with pkgs; [
        inotify-tools
        xorg.libX11
        xorg.libXrandr
        xorg.libXinerama
        xorg.libXcursor
        xorg.libXi
        xorg.libXi
        libGL
      ];
      darwinPkgs = with pkgs.darwin.apple_sdk.frameworks; [
        CoreFoundation
        CoreServices
      ];
    in
    {
      # (...)
      # `nix develop`
      default = devenv.lib.mkShell {
        inherit inputs pkgs;
        modules = [
          (
            { pkgs, lib, ... }:
            {
              packages =
                with pkgs;
                [
                  just
                  raylib
                ]
                ++ lib.optionals stdenv.isLinux (linuxPkgs)
                ++ lib.optionals stdenv.isDarwin darwinPkgs;

              languages.erlang = {
                enable = true;
                package = erlangLatest;
              };

              languages.zig = {
                enable = true;
                package = zigLatest;
              };

              env = mkEnvVars pkgs erlangLatest erlangLibs raylib;

              scripts = {
                build.exec = "just build";
                server.exec = "just server";
                client.exec = "just client";
                db-up.exec = "just db-up";
                db-down.exec = "just db-down";
                db-reset.exec = "just db-reset";
              };

              enterShell = ''
                echo "Starting Development Environment..."
                just deps
              '';

              services.postgres = {
                package = pkgs.postgresql_16.withPackages (p: with p; [ p.periods ]);
                enable = true;
                initialDatabases = [ { name = "mmo"; } ];
                port = 5432;
                listen_addresses = "127.0.0.1";
                initialScript = ''
                  CREATE USER admin SUPERUSER;
                  ALTER USER admin PASSWORD 'admin';
                  GRANT ALL PRIVILEGES ON DATABASE mmo to admin;
                '';
              };
            }
          )
        ];
      };
    };

  # (...)
</pre>
</div>

<p>
Let's try building the <code>Zig</code> client:
</p>

<div class="org-src-container">
<pre class="src src-shell">  $ just client-build
  $ just client
</pre>
</div>



<figure id="org094bdd9">
<img src="../static/img/some_experiments_with_nix_and_erlang/00_lyceum_client.png" alt="00_lyceum_client.png" width="50%" height="50%" align="center">

<figcaption><span class="figure-number">Figure 1: </span>It just works</figcaption>
</figure>
</div>
<div id="outline-container-orgcf7a147" class="outline-4">
<h4 id="orgcf7a147">Running Postgres</h4>
<div class="outline-text-4" id="text-orgcf7a147">
<p>
As you may have noticed, not only are we installing <code>Erlang</code> and <code>Zig</code>, some
madlad even put <code>dbeaver</code> there for God knows what reason, but hey, that's the dev
shell, just do whatever you want. We also have a local postgres setup and the
workflow mimics what you usually have with <code>docker-compose</code> or <code>podman</code>. By running:
</p>

<div class="org-src-container">
<pre class="src src-shell">  devenv up
</pre>
</div>

<p>
inside the shell, a local <code>Postgres 16</code> with custom extensions will be
spinned. The list of services supported by <code>devenv</code> keeps growing and you can
check them <a href="https://devenv.sh/services/#supported-services">here</a>.
</p>


<figure id="org63fdf8a">
<img src="../static/img/some_experiments_with_nix_and_erlang/01_postgres.png" alt="01_postgres.png" width="50%" height="50%" align="center">

<figcaption><span class="figure-number">Figure 2: </span>It just works (x2)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-orgc58779c" class="outline-4">
<h4 id="orgc58779c">Direnv</h4>
<div class="outline-text-4" id="text-orgc58779c">
<p>
As if thigs weren't awesome enough, I need to talk about <a href="https://direnv.net/">direnv</a>, a simple tool
that can make wonders (and it comes with nix integrations for free), with a
single <code>.envrc</code> in your project's repo you can jump inside a certain development
shell just by <code>cd</code>-ing into the directory. Here's an example of my
<code>.envrc</code>:
</p>

<div class="org-src-container">
<pre class="src src-nil">use flake . --impure
</pre>
</div>

<p>
followed by a <code>direnv allow</code> in my shell:
</p>

<div class="org-src-container">
<pre class="src src-shell">  $ direnv allow   
  direnv: loading ~/Code/Personal/lyceum/.envrc                                                                                                                   
  direnv: using flake . --impure
  direnv: nix-direnv: Renewed cache
  Starting Development Environment...
  rebar3 get-deps
  ===&gt; Verifying dependencies...
  rebar3 nix lock
  ===&gt; Verifying dependencies...
  # (...)
</pre>
</div>

<p>
That's it. Now every time I <code>cd &lt;lyceum-directory&gt;</code>, I'll immediatly load the
whole development shell and be ready to work on it. This section is optional but
it really simplifies my life, as I don't need to remember to activate/deactivate
an environment.
</p>
</div>
</div>
</div>
<div id="outline-container-orgcdc6ac7" class="outline-3">
<h3 id="orgcdc6ac7">The CI environment</h3>
<div class="outline-text-3" id="text-orgcdc6ac7">
<p>
Since we are already went to the trouble of setting up a whole dev environment
for Erlang and Zig, we should just make another one for when we need to run
builds and test suites on CI.
</p>

<div class="org-src-container">
<pre class="src src-nix">   # `nix develop .#ci`
   # reduce the number of packages to the bare minimum needed for CI
   ci = pkgs.mkShell {
     env = mkEnvVars pkgs erlangLatest erlangLibs raylib;
     buildInputs = with pkgs; [
       erlangLatest
       just
       rebar3
       rsync
       zigLatest
       raylib
     ];
   };
</pre>
</div>

<p>
If you use Github Actions, now you can leverage both the <a href="https://github.com/cachix/install-nix-action">Install Nix</a> and <a href="https://github.com/DeterminateSystems/magic-nix-cache">Magic
Nix Cache</a> actions.
</p>
</div>
</div>
<div id="outline-container-org94096a2" class="outline-3">
<h3 id="org94096a2">The full devshell</h3>
<div class="outline-text-3" id="text-org94096a2">
<p>
You can check what the full devshell looks like <a href="https://github.com/Dr-Nekoma/lyceum/blob/master/flake.nix">here</a>.
</p>
</div>
</div>
</div>
<div id="outline-container-orgb23678e" class="outline-2">
<h2 id="orgb23678e">Nix Build</h2>
<div class="outline-text-2" id="text-orgb23678e">
<p>
In the previous section I've showed you our impure environment, there's no way
(as of now) to make things 100% pure while developing, specially because we need
to have a postgres service running to debug and test locally. However, things
change when we talk about releases, we need to find a way to properly build the
server.
</p>
</div>
<div id="outline-container-org7735d1c" class="outline-3">
<h3 id="org7735d1c">A pure build of the Erlang server</h3>
<div class="outline-text-3" id="text-org7735d1c">
<p>
This is the original reason I've decided to write this, it took me some time to
go through the <a href="https://nixos.org/manual/nixpkgs/stable/#sec-beam">NixOS BEAM manual</a> and I've yet to know how to properly build this
project with the <a href="https://nixos.org/manual/nixpkgs/stable/#build-tools-rebar3">buildRebar3 Tools</a> (it seems it's used more inside Nixpkgs
itself than to integrate with Erlang projects). Nevertheless, you can properly
package this with the abstractions plain Nix already gives you:
</p>

<div class="org-src-container">
<pre class="src src-nix">  # Leverages nix to build the erlang backend release
  # nix build .#server
  server =
    let
      deps = import ./server/rebar-deps.nix { 
        inherit (pkgs) fetchHex fetchFromGitHub fetchgit;
        builder = pkgs.beamPackages.buildRebar3;
      };
    in
    pkgs.beamPackages.rebar3Relx {
      pname = erl_app;
      version = "0.1.0";
      root = ./server;
      src = pkgs.lib.cleanSource ./server;
      releaseType = "release";
      profile = "prod";
      beamDeps = builtins.attrValues deps;
    };
</pre>
</div>

<p>
This is a derivation, a meta-package, a recipe containing every step and every
dependecy I need to satisfy and properly build our server. Now, as for the
<code>deps.nix</code> file, it was auto-generated with <a href="https://github.com/erlang-nix/rebar3_nix">rebar3-nix</a>, which itself has a <code>rebar3</code>
plugin. So everytime someone adds a BEAM dependency in our current flow, we
automatically generate a nix lockfile to match the rebar3 lockfile as
well. Here's what we needed to add in our <code>rebar3</code> config to benefit from the Nix
integration:
</p>

<div class="org-src-container">
<pre class="src src-nil">{plugins, [
    { rebar3_nix, ".*", {git, "https://github.com/erlang-nix/rebar3_nix.git", {tag, "v0.1.1"}}}
]}.
</pre>
</div>

<p>
now let's see if this really works:
</p>

<div class="org-src-container">
<pre class="src src-shell">  $ nix build .#server
  # (...)
  # We now have a `result` directory in the project's root...
  $ ls ./result/
  bin  database  erts-13.2.2.10  lib  releases
  # Now try running the server we've just build and...
  $ ./result/bin/server foreground
  Exec: /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/erts-13.2.2.10/bin/erlexec -noinput +Bd -boot /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/releases/0.0.1/start -mode embedded -boot_var SYSTEM_LIB_DIR /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/lib -config /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/releases/0.0.1/sys.config -args_file /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/releases/0.0.1/vm.args -- foreground
  Root: /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server
  /nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server
  Connecting to: "127.0.0.1"
  Connected to "127.0.0.1" with USER = "admin"
  Finding migration scripts... 
  Migration Path: "/nix/store/cm6vsbfls41q6s5ms4y2gfnxvmx1qzfq-server/database/migrations"
  Running DB migrations.
  Migrations completed successfully.
  # (...) it works
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgaa07f2d" class="outline-2">
<h2 id="orgaa07f2d">Containers</h2>
<div class="outline-text-2" id="text-orgaa07f2d">
<p>
There is a treasure trove of examples in <a href="https://github.com/NixOS/nixpkgs/blob/master/pkgs/build-support/docker/examples.nix#L218">Nixpkgs</a>, I've decided to go with the
<b><b>simplest</b></b> one. This what a container for the backend looks like in Nix:
</p>

<div class="org-src-container">
<pre class="src src-nix">  # nix build .#dockerImage
  dockerImage = pkgs.dockerTools.buildLayeredImage {
    name = erl_app;
    tag = "latest";
    created = "now";
    # This will copy the compiled erlang release to the image
    contents = [
      server
      pkgs.coreutils
      pkgs.gawk
      pkgs.gnugrep
      pkgs.openssl
    ];
    config = {
      Volumes = {
        "/opt/${erl_app}/etc" = {};
        "/opt/${erl_app}/data" = {};
        "/opt/${erl_app}/log" = {};
      };
      WorkingDir = "/opt/${erl_app}";
      Cmd = [
        "${server}/bin/${erl_app}"
        "foreground"
      ];
      Env = [
        "ERL_DIST_PORT=8080"
        "ERL_AFLAGS=\"-kernel shell_history enabled\""
        "NODE_NAME=${erl_app}"
      ];
      ExposedPorts = {
        "4369/tcp" = {};
        "4369/ucp" = {};
        "8080/tcp" = {};
        "8080/udp" = {};
      };
    };
  };

</pre>
</div>

<p>
It doesn't really look like most Dockerfiles you see around the net. Notice that
I'm using the <code>server</code> derivation from the previous step, the hard work required
to make it work the first time is immediatly rewarded because now we can keep
composing the previous solutions into more complex flows. To test this, let's
build the image:
</p>

<div class="org-src-container">
<pre class="src src-shell">  $ nix build .#dockerImage
  # Now load the build image in docker (or podman)
  $ docker load &lt; ./result
  # Make sure you have `devenv up` running
  $ docker container run --network=host --rm lyceum:latest
  Exec: /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/erts-13.2.2.10/bin/erlexec -noinput +Bd -boot /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/releases/0.0.1/start -mode embedded -boot_var SYSTEM_LIB_DIR /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/lib -config /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/releases/0.0.1/sys.config -args_file /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/releases/0.0.1/vm.args -- foreground
  Root: /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server
  /nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server
  server[1] Starting up
  Connecting to: "127.0.0.1"
  Connected to "127.0.0.1" with USER = "admin"
  Finding migration scripts... 
  Migration Path: "/nix/store/vwnrgsah54qf9ca0ax921061b6sm1km9-server/database/migrations"
  Running DB migrations.
  Migrations completed successfully.
  # (...)
</pre>
</div>
</div>
</div>
<div id="outline-container-org7c07ea9" class="outline-2">
<h2 id="org7c07ea9">Conclusion</h2>
<div class="outline-text-2" id="text-org7c07ea9">
<p>
As I wanted to show here, we've used Nix all the way from defining a common
development environment for the developers, reused some of the stuff in CI, to
later repurpose some of the flows for pure builds, that later got shoved into
our containers, all by leveraging the <b><b>same tool</b></b>. I wish modern devops was more
about that, but it seems it'll take time for people to realize that
<b><b>immutability</b></b>, <b><b>composition</b></b> and <b><b>functional programming</b></b> can go hand in hand
and give us a better experience than one can find in most other solutions (built
by trillion dollar companies who want you to manage infra with YAML). Luckilly,
Nix is <a href="https://www.youtube.com/watch?v=FJVFXsNzYZQ">gaining some traction</a> and more people are talking about it.
</p>

<p>
I've been using it for the past 6 years in my workstations and don't regret
doing so, its a tool worth learning (and there's still so much to learn about
it), it makes my life dealing with Unix systems less painfull.
</p>
</div>
<div id="outline-container-org59dc2c5" class="outline-3">
<h3 id="org59dc2c5"><span class="todo TODO">TODO</span> </h3>
<div class="outline-text-3" id="text-org59dc2c5">
<p>
There is still much to do, and it can be left for a part II later.
</p>

<ul class="org-ul">
<li class="off"><code>[&#xa0;]</code> I have yet to learn how to deploy a production-ready erlang system. Add
(<a href="#citeproc_bib_item_1">Cesarini and Vinoski 2016</a>) to my readlist.</li>
<li class="off"><code>[&#xa0;]</code> Properly build the client, it seems that <a href="https://github.com/nix-community/zon2nix">non2nix</a> breaks with the <a href="https://github.com/nix-community/zon2nix/issues/6">format for
zon files</a>, I'm not familiar with Zig toolig and ill take a look at this later</li>
</ul>

<style>.csl-entry{text-indent: -1.5em; margin-left: 1.5em;}</style><div class="csl-bib-body">
  <div class="csl-entry"><a id="citeproc_bib_item_1"></a>Cesarini, Francesco, and Steve Vinoski. 2016. <i>Designing for Scalability with Erlang/Otp: Implement Robust, Fault-Tolerant Systems</i>. O’Reilly Media, Inc.</div>
</div>
</div>
</div>
</div>
</main>
<footer id="postamble" class="status">
<footer>
  </br>
  <p>
  Built with <a href="https://orgmode.org/">Orgmode</a>, <a href="https://www.gnu.org/software/emacs/">Emacs</a> and <a href="https://nixos.org/">Nix</a>, source code availiable <a href="https://github.com/mtrsk/mtrsk.github.io">here</a>.
  </p>
</footer>
</footer>
</body>
</html>
